"use strict";function adaptScreen(){paper.height=Math.max(document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight),paper.width=Math.max(document.body.offsetWidth,document.documentElement.offsetWidth,document.body.clientWidth,document.documentElement.clientWidth),paper.size(paper.width,paper.height),ANIMATION.maxSpectrumHeight=paper.height/4*3}function draw(){var e=ANIMATION.type;if("none"===e)return cancelAnimationFrame(ANIMATION.drawLoop),void paper.clear();ANIMATION.drawLoop=requestAnimationFrame(draw);var t=ANIMATION.dataArray;if("spectrum-linear"===e){SYNTH.nodes.analyser.getByteFrequencyData(ANIMATION.dataArray),paper.clear();for(var n=paper.width/(2*t.length),o=0;o<t.length;++o){var a=paper.height-ANIMATION.maxSpectrumHeight*t[o]/256;paper.rect({x:2*o*n,y:a,width:n,height:paper.height,fill:"hsl("+360*o/t.length+", 100%, 50%)"})}}else if("spectrum-round"===e){SYNTH.nodes.analyser.getByteFrequencyData(ANIMATION.dataArray);var r=360/t.length,i=window.innerWidth/2,s=window.innerHeight/2,c=80,l=3*c;paper.clear();for(var o=0;o<t.length;++o){var p=o*r*Math.PI/180,u=Math.cos(p),d=Math.sin(p),m=i+u*c,v=s+d*c,h=t[o]*l/512+c,g=i+u*h,f=s+d*h;paper.line({x1:m,y1:v,x2:g,y2:f,stroke:"hsl("+360*o/t.length+", 100%, 50%)",join:"miter",thickness:1})}}else if("spectrum-roundinset"===e){SYNTH.nodes.analyser.getByteFrequencyData(ANIMATION.dataArray);var r=360/t.length,i=window.innerWidth/2,s=window.innerHeight/2,c=240,l=c;paper.clear();for(var o=0;o<t.length;++o){var p=o*r*Math.PI/180,u=Math.cos(p),d=Math.sin(p),m=i+u*c,v=s+d*c,h=-(t[o]*l/512)+c,g=i+u*h,f=s+d*h;paper.line({x1:m,y1:v,x2:g,y2:f,stroke:"hsl("+360*o/t.length+", 100%, 50%)",join:"miter",thickness:1})}}else if("oscilloscope-stroked"===e){SYNTH.nodes.analyser.getByteTimeDomainData(ANIMATION.dataArray),paper.clear(),paper.context.lineWidth=15,ANIMATION.hue=ANIMATION.hue+.5>360?0:ANIMATION.hue+.5,paper.context.strokeStyle="hsl("+ANIMATION.hue+", 50%, 50%)",paper.context.beginPath();for(var N=1*paper.width/t.length,m=0,o=0;o<t.length;++o){var y=t[o]/128,v=y*paper.height/2;0===o?paper.context.moveTo(m,v):paper.context.lineTo(m,v),m+=N}paper.context.stroke()}else if("oscilloscope-filled"===e){SYNTH.nodes.analyser.getByteTimeDomainData(ANIMATION.dataArray),paper.clear(),paper.context.lineWidth=15,ANIMATION.hue=ANIMATION.hue+.5>360?0:ANIMATION.hue+.5,paper.context.fillStyle="hsl("+ANIMATION.hue+", 50%, 50%)",paper.context.beginPath();for(var N=1*paper.width/t.length,m=0,o=0;o<t.length;++o){var y=t[o]/128,v=y*paper.height/2;0===o?paper.context.moveTo(m,v):paper.context.lineTo(m,v),m+=N}paper.context.lineTo(paper.width,paper.height),paper.context.lineTo(0,paper.height),paper.context.fill()}else"blackboard"===e&&(paper.clear(),points.forEach(function(e){paper.circle({x:e.x,y:e.y,r:50,fill:e.color,shadow:"0 0 20 "+e.color})}))}function connectKeyboard(e){var t=new QwertyHancock({id:"keyboard",width:window.innerWidth,height:window.innerHeight/2,octaves:2,startNote:e,whiteKeyColour:"#E7ECEE",blackKeyColour:"#1F2022",activeColour:"#46C891",borderColour:"black",keyboardLayout:"en"});return t.keyDown=function(e,t){SYNTH.addVoice("keyboard-"+e,t,.5)},t.keyUp=function(e){SYNTH.removeVoice("keyboard-"+e)},t}$("#splash-screen").delay(2e3).fadeOut(),$(".sidebar button").on("click",function(){var e=$("#module-"+$(this).data("module"));e.is(":visible")?e.hide():($(".module").hide(),e.show())});var SYNTH={nodes:{},voices:new Map,context:new(window.AudioContext||window.webkitAudioContext),settings:{osc1:{type:"sawtooth",detune:0,mix:1},osc2:{type:"none",detune:0,mix:1},filter:{type:"lowpass",detune:0,frequency:0,quality:0,gain:0},effect:{type:"none"},compressor:{threshold:-24,knee:30,ratio:12,reduction:0,attack:.003,release:.25},master:{volume:1,pan:0},animation:{type:"spectrum-round",fftSize:512,smoothingTimeConstant:.8,minDecibels:-100,maxDecibels:-30}},setupSettings:function(e){e=e||SYNTH.settings;var t=SYNTH.nodes;$("#osc1-type").val(e.osc1.type).trigger("change"),$("#osc1-detune").val(e.osc1.detune).trigger("input"),$("#osc1-mix").val(e.osc1.mix).trigger("input"),$("#osc2-type").val(e.osc2.type).trigger("change"),$("#osc2-detune").val(e.osc2.detune).trigger("input"),$("#osc2-mix").val(e.osc2.mix).trigger("input"),t.sharedFilter.type=e.filter.type,t.sharedFilter.detune.value=e.filter.detune,t.sharedFilter.frequency.value=Math.min(e.filter.frequency,SYNTH.context.sampleRate/2),t.sharedFilter.Q.value=e.filter.quality,t.sharedFilter.gain.value=e.filter.gain,$("#filter-type").val(e.filter.type).trigger("change"),$("#filter-detune").val(e.filter.detune).trigger("input"),$("#filter-frequency").val(e.filter.frequency).trigger("input"),$("#filter-quality").val(e.filter.quality).trigger("input"),$("#filter-gain").val(e.filter.gain).trigger("input"),t.blender.gain.value=1,t.compressor.threshold.value=e.compressor.threshold,t.compressor.knee.value=e.compressor.knee,t.compressor.ratio.value=e.compressor.ratio,t.compressor.reduction.value=e.compressor.reduction,t.compressor.attack.value=e.compressor.attack,t.compressor.release.value=e.compressor.release,$("#compressor-threshold").val(e.compressor.threshold).trigger("input"),$("#compressor-knee").val(e.compressor.knee).trigger("input"),$("#compressor-ratio").val(e.compressor.ratio).trigger("input"),$("#compressor-reduction").val(e.compressor.reduction).trigger("input"),$("#compressor-attack").val(e.compressor.attack).trigger("input"),$("#compressor-release").val(e.compressor.release).trigger("input"),t.panner.pan.value=e.master.pan,$("#master-pan").val(e.master.pan).trigger("input"),t.master.gain.value=e.master.volume,$("#master-volume").val(e.master.volume).trigger("input"),t.analyser.fftSize=e.animation.fftSize,t.analyser.smoothingTimeConstant=e.animation.smoothingTimeConstant,t.analyser.minDecibels=e.animation.minDecibels,t.analyser.maxDecibels=e.animation.maxDecibels,$("#animation-type").val(e.animation.type),$("#animation-analyser-fft").val(e.animation.fftSize).trigger("change"),$("#animation-analyser-smoothingTimeConstant").val(e.animation.smoothingTimeConstant).trigger("input"),$("#animation-analyser-minDecibels").val(e.animation.minDecibels).trigger("input"),$("#animation-analyser-maxDecibels").val(e.animation.maxDecibels).trigger("input")},addVoice:function(e,t,n,o){var a=SYNTH.settings,r=SYNTH.context.createOscillator();SYNTH.wavetables[a.osc1.type]?r.setPeriodicWave(SYNTH.wavetables[a.osc1.type].wave):r.type=a.osc1.type,r.frequency.value=t,r.detune.value=a.osc1.detune,r.start(0);var i=SYNTH.context.createGain();i.gain.value=a.osc1.mix;var s,c;"none"!==a.osc2.type&&(s=SYNTH.context.createOscillator(),SYNTH.wavetables[a.osc1.type]?s.setPeriodicWave(SYNTH.wavetables[a.osc2.type].wave):s.type=a.osc2.type,s.frequency.value=t,s.detune.value=a.osc2.detune,s.start(0),c=SYNTH.context.createGain(),c.gain.value=a.osc2.mix);var l=SYNTH.context.createGain();l.gain.value=n;var p=null;-1===e.indexOf("keyboard")&&(p=SYNTH.context.createBiquadFilter(),p.type=a.filter.type,p.detune.value=a.filter.detune,p.frequency.value=Math.min(o||a.filter.frequency,SYNTH.context.sampleRate/2),p.Q.value=a.filter.quality,p.gain.value=a.filter.gain),r.connect(i),i.connect(l),"none"!==a.osc2.type&&(s.connect(c),c.connect(l)),-1===e.indexOf("keyboard")?(l.connect(p),p.connect(SYNTH.nodes.blender)):l.connect(SYNTH.nodes.sharedFilter),SYNTH.voices.has(e)&&SYNTH.removeVoice(e),SYNTH.voices.set(e,{id:e,osc1:{osc:r,mix:i},osc2:"none"!==a.osc2.type?{osc:s,mix:c}:null,velocity:l,filter:p})},updateVoice:function(e,t,n,o){if(SYNTH.voices.has(e)){var a=SYNTH.voices.get(e);a.osc1.osc.frequency.value=t,null!==a.osc2&&(a.osc2.osc.frequency.value=t),null!==n&&(a.velocity.gain.value=n),null!==a.filter&&null!==o&&(a.filter.frequency.value=o)}},removeVoice:function(e){if(SYNTH.voices.has(e)){var t=SYNTH.voices.get(e);t.osc1.osc.stop(0),t.osc1.osc.disconnect(),t.osc1.mix.disconnect(),null!==t.osc2&&(t.osc2.osc.stop(0),t.osc2.osc.disconnect(),t.osc2.mix.disconnect()),t.velocity.disconnect(),null!==t.filter&&t.filter.disconnect(),SYNTH.voices.delete(e)}}};SYNTH.nodes.sharedFilter=SYNTH.context.createBiquadFilter(),SYNTH.nodes.blender=SYNTH.context.createGain(),SYNTH.nodes.compressor=SYNTH.context.createDynamicsCompressor(),SYNTH.nodes.panner=SYNTH.context.createStereoPanner(),SYNTH.nodes.master=SYNTH.context.createGain(),SYNTH.nodes.analyser=SYNTH.context.createAnalyser(),SYNTH.nodes.sharedFilter.connect(SYNTH.nodes.blender),SYNTH.nodes.blender.connect(SYNTH.nodes.compressor),SYNTH.nodes.compressor.connect(SYNTH.nodes.panner),SYNTH.nodes.panner.connect(SYNTH.nodes.master),SYNTH.nodes.master.connect(SYNTH.nodes.analyser),SYNTH.nodes.analyser.connect(SYNTH.context.destination),SYNTH.settings.filter.frequency=SYNTH.context.sampleRate/2,SYNTH.setupSettings(),SYNTH.wavetables={horn:{real:[0,.4,.4,1,1,1,.3,.7,.6,.5,.9,.8],imag:null}},function(){for(var e in SYNTH.wavetables)if(SYNTH.wavetables.hasOwnProperty(e)){var t=SYNTH.wavetables[e];t.real=new Float32Array(t.real),t.imag=new Float32Array(null!==t.imag?t.imag:t.real.length),t.wave=SYNTH.context.createPeriodicWave(t.real,t.imag)}}(),$("#osc1-type").on("change",function(){SYNTH.settings.osc1.type=$(this).val(),SYNTH.voices.forEach(function(e){SYNTH.removeVoice(e.id)})}),$("#osc1-detune").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc1.detune=e,SYNTH.voices.forEach(function(t){t.osc1.osc.detune.value=e})}),$("#osc1-mix").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc1.mix=e,SYNTH.voices.forEach(function(t){t.osc1.mix.gain.value=e})}),$("#osc2-type").on("change",function(){SYNTH.settings.osc2.type=$(this).val(),SYNTH.voices.forEach(function(e){SYNTH.removeVoice(e.id)})}),$("#osc2-detune").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc2.detune=e,SYNTH.voices.forEach(function(t){null!==t.osc2&&(t.osc2.osc.detune.value=e)})}),$("#osc2-mix").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc2.mix=e,SYNTH.voices.forEach(function(t){null!==t.osc2&&(t.osc2.mix.gain.value=e)})}),$("#filter-type").on("change",function(){SYNTH.settings.filter.type=$(this).val(),SYNTH.nodes.sharedFilter.type=$(this).val(),SYNTH.voices.forEach(function(e){null!==e.filter&&(e.filter.type=$(this).val())})}),$("#filter-detune").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.detune=e,SYNTH.nodes.sharedFilter.detune.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.detune.value=e)})}),$("#filter-frequency").attr("max",SYNTH.context.sampleRate/2).on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.frequency=e,SYNTH.nodes.sharedFilter.frequency.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.frequency.value=e)})}),$("#filter-quality").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.quality=e,SYNTH.nodes.sharedFilter.Q.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.Q.value=e)})}),$("#filter-gain").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.gain=e,SYNTH.nodes.sharedFilter.gain.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.gain.value=e)})}),$("#compressor-threshold").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.threshold=e,SYNTH.nodes.compressor.threshold.value=e}),$("#compressor-knee").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.knee=e,SYNTH.nodes.compressor.knee.value=e}),$("#compressor-ratio").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.ratio=e,SYNTH.nodes.compressor.ratio.value=e}),$("#compressor-reduction").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.reduction=e,SYNTH.nodes.compressor.reduction.value=e}),$("#compressor-attack").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.attack=e,SYNTH.nodes.compressor.attack.value=e}),$("#compressor-release").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.release=e,SYNTH.nodes.compressor.release.value=e}),$("#master-volume").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.master.volume=e,SYNTH.nodes.master.gain.value=e}),$("#master-pan").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.master.pan=e,SYNTH.nodes.panner.pan.value=e}),window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame;var paper=new Palette("surface");window.ANIMATION={type:SYNTH.settings.animation.type,dataArray:new Uint8Array(SYNTH.nodes.analyser.frequencyBinCount),drawLoop:null,hue:0,maxSpectrumHeight:paper.height/4*3},$(window).on("resize",adaptScreen).trigger("resize"),$("#animation-type").on("change",function(){ANIMATION.type=$(this).val(),cancelAnimationFrame(ANIMATION.drawLoop),draw()}).trigger("change"),$("#animation-analyser-fft").on("change",function(){SYNTH.nodes.analyser.fftSize=parseInt($(this).val(),10),ANIMATION.dataArray=new Uint8Array(SYNTH.nodes.analyser.frequencyBinCount),$("#animation-type").trigger("change")}),$("#animation-analyser-smoothingTimeConstant").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.analyser.smoothingTimeConstant=e}),$("#animation-analyser-minDecibels").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.analyser.minDecibels=e}),$("#animation-analyser-maxDecibels").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.analyser.maxDecibels=e}),connectKeyboard("C4");var keyboardFirstNote=4;$(window).on("keydown",function(e){90===e.keyCode?(keyboardFirstNote--,0>keyboardFirstNote&&(keyboardFirstNote=0),connectKeyboard("C"+keyboardFirstNote)):88===e.keyCode&&(keyboardFirstNote++,keyboardFirstNote>9&&(keyboardFirstNote=9),connectKeyboard("C"+keyboardFirstNote))});var presets=[],userPresets=[],factoryPresets=[$.extend({id:1,name:"Default"},SYNTH.settings),{id:2,name:"Classic Electric Bass",osc1:{type:"sine",detune:0,mix:1},osc2:{type:"sine",detune:1200,mix:1},filter:{type:"lowpass",detune:0,frequency:22050,quality:0,gain:0},convolver:{type:"none"},compressor:{threshold:-24,knee:30,ratio:12,reduction:0,attack:.003,release:.25},animation:{type:"spectrum-round",settings:512}},{id:3,name:"Buzzer",osc1:{type:"sawtooth",detune:0,mix:1},osc2:{type:"sawtooth",detune:-1200,mix:.5},filter:{type:"lowpass",detune:0,frequency:3e3,quality:26,gain:0},convolver:{type:"none"},compressor:{threshold:-24,knee:30,ratio:12,reduction:0,attack:.003,release:.25},animation:{type:"spectrum-round",settings:512}}];$("#preset-id").on("change",function(){for(var e,t=parseInt($(this).val(),10),n=0;n<presets.length;++n)if(t===presets[n].id){e=presets[n],SYNTH.setupSettings(e);break}}).on("update",function(){var e=$(this);e.empty(),presets.forEach(function(t){e.append('<option value="'+t.id+'">'+t.name+"</option>")}),e.trigger("change")}),$("#preset-save").on("click",function(){var e=prompt("Preset name");if(e){var t=$.extend({id:Date.now(),name:e},SYNTH.settings);presets.push(t),localforage.setItem("presets",presets,function(e){e?console.error(e):$("#preset-id").trigger("update")})}}),localforage.getItem("presets",function(e,t){e&&console.error(e),t&&(window.presets=t,$("#preset-id").trigger("update")),e||t||localforage.setItem("presets",window.presets,function(e){e?console.error(e):$("#preset-id").trigger("update")})});var points=new Map;$("#surface").on("pointerenter pointerover",function(e){e.originalEvent&&(e=e.originalEvent)}).on("pointerdown",function(e){e.originalEvent&&(e=e.originalEvent);var t=27.5,n=SYNTH.context.sampleRate/2,o=1-1*e.pageY/paper.height,a=Math.log(n/t)/Math.LN2,r=Math.pow(2,a*(o-1)),i=n*r,t=27.5,n=4186.01,o=1*e.pageX/paper.width,a=Math.log(n/t)/Math.LN2,r=Math.pow(2,a*(o-1)),s=n*r;if(SYNTH.addVoice("pointer-"+e.pointerId,s,e.pressure,i),!points.has(e.pointerId)){var c=["#D34D2E","#FF9900","#F3CF3A","#44DE43","#3DC186","#37BBBA","#4DC3FA","#B158B6","#FB6368","#F23A65"];points.set(e.pointerId,{id:e.pointerId,x:e.pageX,y:e.pageY,color:c[Math.floor(Math.random()*c.length)]})}}).on("pointermove",function(e){if(e.originalEvent&&(e=e.originalEvent),SYNTH.voices.has("pointer-"+e.pointerId)){var t=27.5,n=SYNTH.context.sampleRate/2,o=1-1*e.pageY/paper.height,a=Math.log(n/t)/Math.LN2,r=Math.pow(2,a*(o-1)),i=n*r,t=27.5,n=4186.01,o=1*e.pageX/paper.width,a=Math.log(n/t)/Math.LN2,r=Math.pow(2,a*(o-1)),s=n*r;if(SYNTH.updateVoice("pointer-"+e.pointerId,s,null,i),points.has(e.pointerId)){var c=points.get(e.pointerId);c.x=e.pageX,c.y=e.pageY}}}).on("pointerup pointercancel pointerout pointerleave",function(e){e.originalEvent&&(e=e.originalEvent),SYNTH.removeVoice("pointer-"+e.pointerId),points.has(e.pointerId)&&points.delete(e.pointerId)}),$(document).on("touchmove",function(e){e.preventDefault()}),$(document).on("visibilitychange mozvisibilitychange msvisibilitychange webkitvisibilitychange",function(){(document.hidden||document.mozHidden||document.msHidden||document.webkitHidden)&&SYNTH.voices.forEach(function(e){SYNTH.removeVoice(e.id)})});