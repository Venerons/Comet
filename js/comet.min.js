"use strict";function adaptScreen(){paper.height=Math.max(document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight),paper.width=Math.max(document.body.offsetWidth,document.documentElement.offsetWidth,document.body.clientWidth,document.documentElement.clientWidth),paper.size(paper.width,paper.height),ANIMATION.maxSpectrumHeight=paper.height/4*3}function draw(){var e=ANIMATION.type;if("none"===e)return cancelAnimationFrame(ANIMATION.drawLoop),void paper.clear();ANIMATION.drawLoop=requestAnimationFrame(draw);var t=ANIMATION.dataArray;if("spectrum-linear"===e){SYNTH.nodes.analyser.getByteFrequencyData(ANIMATION.dataArray),paper.clear();for(var n=paper.width/(2*t.length),a=0;a<t.length;++a){var o=paper.height-ANIMATION.maxSpectrumHeight*t[a]/256;paper.rect({x:2*a*n,y:o,width:n,height:paper.height,fill:"hsl("+360*a/t.length+", 100%, 50%)"})}}else if("spectrum-round"===e){SYNTH.nodes.analyser.getByteFrequencyData(ANIMATION.dataArray);var i=360/t.length,r=window.innerWidth/2,s=window.innerHeight/2,c=80,l=3*c;paper.clear();for(var a=0;a<t.length;++a){var p=a*i*Math.PI/180,u=Math.cos(p),d=Math.sin(p),m=r+u*c,h=s+d*c,v=t[a]*l/512+c,g=r+u*v,f=s+d*v;paper.line({x1:m,y1:h,x2:g,y2:f,stroke:"hsl("+360*a/t.length+", 100%, 50%)",join:"miter",thickness:1})}}else if("spectrum-roundinset"===e){SYNTH.nodes.analyser.getByteFrequencyData(ANIMATION.dataArray);var i=360/t.length,r=window.innerWidth/2,s=window.innerHeight/2,c=240,l=c;paper.clear();for(var a=0;a<t.length;++a){var p=a*i*Math.PI/180,u=Math.cos(p),d=Math.sin(p),m=r+u*c,h=s+d*c,v=-(t[a]*l/512)+c,g=r+u*v,f=s+d*v;paper.line({x1:m,y1:h,x2:g,y2:f,stroke:"hsl("+360*a/t.length+", 100%, 50%)",join:"miter",thickness:1})}}else if("oscilloscope-stroked"===e){SYNTH.nodes.analyser.getByteTimeDomainData(ANIMATION.dataArray),paper.clear(),paper.context.lineWidth=15,ANIMATION.hue=ANIMATION.hue+.5>360?0:ANIMATION.hue+.5,paper.context.strokeStyle="hsl("+ANIMATION.hue+", 50%, 50%)",paper.context.beginPath();for(var N=1*paper.width/t.length,m=0,a=0;a<t.length;++a){var T=t[a]/128,h=T*paper.height/2;0===a?paper.context.moveTo(m,h):paper.context.lineTo(m,h),m+=N}paper.context.stroke()}else if("oscilloscope-filled"===e){SYNTH.nodes.analyser.getByteTimeDomainData(ANIMATION.dataArray),paper.clear(),paper.context.lineWidth=15,ANIMATION.hue=ANIMATION.hue+.5>360?0:ANIMATION.hue+.5,paper.context.fillStyle="hsl("+ANIMATION.hue+", 50%, 50%)",paper.context.beginPath();for(var N=1*paper.width/t.length,m=0,a=0;a<t.length;++a){var T=t[a]/128,h=T*paper.height/2;0===a?paper.context.moveTo(m,h):paper.context.lineTo(m,h),m+=N}paper.context.lineTo(paper.width,paper.height),paper.context.lineTo(0,paper.height),paper.context.fill()}else"blackboard"===e&&(paper.clear(),points.forEach(function(e){paper.circle({x:e.x,y:e.y,r:50,fill:e.color,shadow:"0 0 20 "+e.color})}))}$("#splash-screen").delay(2e3).fadeOut(),$(".sidebar button").on("click",function(){var e=$("#module-"+$(this).data("module"));e.is(":visible")?e.hide():($(".module").hide(),e.show())});var SYNTH={nodes:{},voices:new Map,context:new(window.AudioContext||window.webkitAudioContext),presets:[],settings:{osc1:{type:"sawtooth",detune:0,mix:1},osc2:{type:"none",detune:0,mix:1},filter:{type:"lowpass",detune:0,frequency:0,quality:0,gain:0},effect:{type:"none"},compressor:{threshold:-24,knee:30,ratio:12,reduction:0,attack:.003,release:.25},master:{volume:1,pan:0},animation:{type:"spectrum-round",fftSize:512,smoothingTimeConstant:.8,minDecibels:-100,maxDecibels:-30}},setupSettings:function(e){e&&(SYNTH.settings=$.extend(!0,SYNTH.settings,e)),e=SYNTH.settings,console.log("setupSettings",e);var t=SYNTH.nodes;$("#osc1-type").val(e.osc1.type).trigger("change"),$("#osc1-detune").val(e.osc1.detune).trigger("input"),$("#osc1-mix").val(e.osc1.mix).trigger("input"),$("#osc2-type").val(e.osc2.type).trigger("change"),$("#osc2-detune").val(e.osc2.detune).trigger("input"),$("#osc2-mix").val(e.osc2.mix).trigger("input"),t.sharedFilter.type=e.filter.type,t.sharedFilter.detune.value=e.filter.detune,t.sharedFilter.frequency.value=Math.min(e.filter.frequency,SYNTH.context.sampleRate/2),t.sharedFilter.Q.value=e.filter.quality,t.sharedFilter.gain.value=e.filter.gain,$("#filter-type").val(e.filter.type).trigger("change"),$("#filter-detune").val(e.filter.detune).trigger("input"),$("#filter-frequency").val(e.filter.frequency).trigger("input"),$("#filter-quality").val(e.filter.quality).trigger("input"),$("#filter-gain").val(e.filter.gain).trigger("input"),t.blender.gain.value=1,t.compressor.threshold.value=e.compressor.threshold,t.compressor.knee.value=e.compressor.knee,t.compressor.ratio.value=e.compressor.ratio,t.compressor.reduction.value=e.compressor.reduction,t.compressor.attack.value=e.compressor.attack,t.compressor.release.value=e.compressor.release,$("#compressor-threshold").val(e.compressor.threshold).trigger("input"),$("#compressor-knee").val(e.compressor.knee).trigger("input"),$("#compressor-ratio").val(e.compressor.ratio).trigger("input"),$("#compressor-reduction").val(e.compressor.reduction).trigger("input"),$("#compressor-attack").val(e.compressor.attack).trigger("input"),$("#compressor-release").val(e.compressor.release).trigger("input"),t.panner.pan.value=e.master.pan,$("#master-pan").val(e.master.pan).trigger("input"),t.master.gain.value=e.master.volume,$("#master-volume").val(e.master.volume).trigger("input"),t.analyser.fftSize=e.animation.fftSize,t.analyser.smoothingTimeConstant=e.animation.smoothingTimeConstant,t.analyser.minDecibels=e.animation.minDecibels,t.analyser.maxDecibels=e.animation.maxDecibels,$("#animation-type").val(e.animation.type),$("#animation-analyser-fft").val(e.animation.fftSize).trigger("change"),$("#animation-analyser-smoothingTimeConstant").val(e.animation.smoothingTimeConstant).trigger("input"),$("#animation-analyser-minDecibels").val(e.animation.minDecibels).trigger("input"),$("#animation-analyser-maxDecibels").val(e.animation.maxDecibels).trigger("input")},addVoice:function(e,t,n,a){var o=SYNTH.settings,i=SYNTH.context.createOscillator();SYNTH.wavetables[o.osc1.type]?i.setPeriodicWave(SYNTH.wavetables[o.osc1.type].wave):i.type=o.osc1.type,i.frequency.value=t,i.detune.value=o.osc1.detune,i.start(0);var r=SYNTH.context.createGain();r.gain.value=o.osc1.mix;var s,c;"none"!==o.osc2.type&&(s=SYNTH.context.createOscillator(),SYNTH.wavetables[o.osc1.type]?s.setPeriodicWave(SYNTH.wavetables[o.osc2.type].wave):s.type=o.osc2.type,s.frequency.value=t,s.detune.value=o.osc2.detune,s.start(0),c=SYNTH.context.createGain(),c.gain.value=o.osc2.mix);var l=SYNTH.context.createGain();l.gain.value=n;var p=null;-1===e.indexOf("keyboard")&&(p=SYNTH.context.createBiquadFilter(),p.type=o.filter.type,p.detune.value=o.filter.detune,p.frequency.value=Math.min(a||o.filter.frequency,SYNTH.context.sampleRate/2),p.Q.value=o.filter.quality,p.gain.value=o.filter.gain),i.connect(r),r.connect(l),"none"!==o.osc2.type&&(s.connect(c),c.connect(l)),-1===e.indexOf("keyboard")?(l.connect(p),p.connect(SYNTH.nodes.blender)):l.connect(SYNTH.nodes.sharedFilter),SYNTH.voices.has(e)&&SYNTH.removeVoice(e),SYNTH.voices.set(e,{id:e,osc1:{osc:i,mix:r},osc2:"none"!==o.osc2.type?{osc:s,mix:c}:null,velocity:l,filter:p})},updateVoice:function(e,t,n,a){if(SYNTH.voices.has(e)){var o=SYNTH.voices.get(e);o.osc1.osc.frequency.value=t,null!==o.osc2&&(o.osc2.osc.frequency.value=t),null!==n&&(o.velocity.gain.value=n),null!==o.filter&&null!==a&&(o.filter.frequency.value=a)}},removeVoice:function(e){if(SYNTH.voices.has(e)){var t=SYNTH.voices.get(e);t.osc1.osc.stop(0),t.osc1.osc.disconnect(),t.osc1.mix.disconnect(),null!==t.osc2&&(t.osc2.osc.stop(0),t.osc2.osc.disconnect(),t.osc2.mix.disconnect()),t.velocity.disconnect(),null!==t.filter&&t.filter.disconnect(),SYNTH.voices.delete(e)}}};SYNTH.nodes.sharedFilter=SYNTH.context.createBiquadFilter(),SYNTH.nodes.blender=SYNTH.context.createGain(),SYNTH.nodes.compressor=SYNTH.context.createDynamicsCompressor(),SYNTH.nodes.panner=SYNTH.context.createStereoPanner(),SYNTH.nodes.master=SYNTH.context.createGain(),SYNTH.nodes.analyser=SYNTH.context.createAnalyser(),SYNTH.nodes.sharedFilter.connect(SYNTH.nodes.blender),SYNTH.nodes.blender.connect(SYNTH.nodes.compressor),SYNTH.nodes.compressor.connect(SYNTH.nodes.panner),SYNTH.nodes.panner.connect(SYNTH.nodes.master),SYNTH.nodes.master.connect(SYNTH.nodes.analyser),SYNTH.nodes.analyser.connect(SYNTH.context.destination),SYNTH.settings.filter.frequency=SYNTH.context.sampleRate/2,SYNTH.setupSettings(),SYNTH.wavetables={horn:{real:[0,.4,.4,1,1,1,.3,.7,.6,.5,.9,.8],imag:null}},function(){for(var e in SYNTH.wavetables)if(SYNTH.wavetables.hasOwnProperty(e)){var t=SYNTH.wavetables[e];t.real=new Float32Array(t.real),t.imag=new Float32Array(null!==t.imag?t.imag:t.real.length),t.wave=SYNTH.context.createPeriodicWave(t.real,t.imag)}}(),$("#osc1-type").on("change",function(){SYNTH.settings.osc1.type=$(this).val(),SYNTH.voices.forEach(function(e){SYNTH.removeVoice(e.id)})}),$("#osc1-detune").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc1.detune=e,SYNTH.voices.forEach(function(t){t.osc1.osc.detune.value=e})}),$("#osc1-mix").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc1.mix=e,SYNTH.voices.forEach(function(t){t.osc1.mix.gain.value=e})}),$("#osc2-type").on("change",function(){SYNTH.settings.osc2.type=$(this).val(),SYNTH.voices.forEach(function(e){SYNTH.removeVoice(e.id)})}),$("#osc2-detune").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc2.detune=e,SYNTH.voices.forEach(function(t){null!==t.osc2&&(t.osc2.osc.detune.value=e)})}),$("#osc2-mix").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc2.mix=e,SYNTH.voices.forEach(function(t){null!==t.osc2&&(t.osc2.mix.gain.value=e)})}),$("#filter-type").on("change",function(){SYNTH.settings.filter.type=$(this).val(),SYNTH.nodes.sharedFilter.type=$(this).val(),SYNTH.voices.forEach(function(e){null!==e.filter&&(e.filter.type=$(this).val())})}),$("#filter-detune").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.detune=e,SYNTH.nodes.sharedFilter.detune.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.detune.value=e)})}),$("#filter-frequency").attr("max",SYNTH.context.sampleRate/2).on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.frequency=e,SYNTH.nodes.sharedFilter.frequency.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.frequency.value=e)})}),$("#filter-quality").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.quality=e,SYNTH.nodes.sharedFilter.Q.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.Q.value=e)})}),$("#filter-gain").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.gain=e,SYNTH.nodes.sharedFilter.gain.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.gain.value=e)})}),$("#compressor-threshold").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.threshold=e,SYNTH.nodes.compressor.threshold.value=e}),$("#compressor-knee").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.knee=e,SYNTH.nodes.compressor.knee.value=e}),$("#compressor-ratio").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.ratio=e,SYNTH.nodes.compressor.ratio.value=e}),$("#compressor-reduction").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.reduction=e,SYNTH.nodes.compressor.reduction.value=e}),$("#compressor-attack").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.attack=e,SYNTH.nodes.compressor.attack.value=e}),$("#compressor-release").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.release=e,SYNTH.nodes.compressor.release.value=e}),$("#master-volume").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.master.volume=e,SYNTH.nodes.master.gain.value=e}),$("#master-pan").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.master.pan=e,SYNTH.nodes.panner.pan.value=e}),window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame;var paper=new Palette("surface");window.ANIMATION={type:SYNTH.settings.animation.type,dataArray:new Uint8Array(SYNTH.nodes.analyser.frequencyBinCount),drawLoop:null,hue:0,maxSpectrumHeight:paper.height/4*3},$(window).on("resize",adaptScreen).trigger("resize"),$("#animation-type").on("change",function(){ANIMATION.type=$(this).val(),cancelAnimationFrame(ANIMATION.drawLoop),draw()}).trigger("change"),$("#animation-analyser-fft").on("change",function(){SYNTH.nodes.analyser.fftSize=parseInt($(this).val(),10),ANIMATION.dataArray=new Uint8Array(SYNTH.nodes.analyser.frequencyBinCount),$("#animation-type").trigger("change")}),$("#animation-analyser-smoothingTimeConstant").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.analyser.smoothingTimeConstant=e}),$("#animation-analyser-minDecibels").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.analyser.minDecibels=e}),$("#animation-analyser-maxDecibels").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.analyser.maxDecibels=e}),function(){function e(e){var t=document.getElementById("keyboard");t&&t.remove(),t=document.createElement("div"),t.hidden=!0,t.setAttribute("id","keyboard"),document.body.appendChild(t);var n=new QwertyHancock({id:"keyboard",width:window.innerWidth,height:window.innerHeight/2,octaves:2,startNote:e,whiteKeyColour:"#E7ECEE",blackKeyColour:"#1F2022",activeColour:"#46C891",borderColour:"black",keyboardLayout:"en"});return n.keyDown=function(e,t){SYNTH.addVoice("keyboard-"+e,t,.5)},n.keyUp=function(e){SYNTH.removeVoice("keyboard-"+e)},n}e("C4")}(),[{id:1,name:"Default"},{id:2,name:"Classic Electric Bass",osc1:{type:"sine",detune:0,mix:1},osc2:{type:"sine",detune:1200,mix:1}},{id:3,name:"Buzzer",osc1:{type:"sawtooth",detune:0,mix:1},osc2:{type:"sawtooth",detune:-1200,mix:.5},filter:{type:"lowpass",detune:0,frequency:3e3,quality:26,gain:0}},{id:4,name:"ChipChip",osc1:{type:"square",detune:464,mix:1},filter:{type:"highpass",detune:0,frequency:5e3,quality:30,gain:0}},{id:5,name:"Organth",osc1:{type:"sawtooth",detune:-456,mix:1},filter:{type:"highpass",detune:0,frequency:1716,quality:9.6,gain:18}}].forEach(function(e){var t=$.extend(!0,{},SYNTH.settings);SYNTH.presets.push($.extend(!0,t,e))}),$("#preset-id").on("change",function(){for(var e=parseInt($(this).val(),10),t=0;t<SYNTH.presets.length;++t)if(e===SYNTH.presets[t].id){SYNTH.setupSettings(SYNTH.presets[t]);break}}).on("update",function(e){var t=$(this),n=null!==t.val()?t.val():1;t.empty(),SYNTH.presets.forEach(function(e){t.append('<option value="'+e.id+'">'+e.name+"</option>")}),t.val(void 0!==e.toBeSelected?e.toBeSelected:n).trigger("change")}).trigger("update"),$("#preset-save").on("click",function(){var e=prompt("Preset name");if(e){var t=$.extend(!0,{id:Date.now(),name:e},SYNTH.settings);SYNTH.presets.push(t),$("#preset-id").trigger({type:"update",toBeSelected:t.id})}});var points=new Map;$("#surface").on("pointerenter pointerover",function(e){e.originalEvent&&(e=e.originalEvent)}).on("pointerdown",function(e){e.originalEvent&&(e=e.originalEvent);var t=27.5,n=SYNTH.context.sampleRate/2,a=1-1*e.pageY/paper.height,o=Math.log(n/t)/Math.LN2,i=Math.pow(2,o*(a-1)),r=n*i,t=27.5,n=4186.01,a=1*e.pageX/paper.width,o=Math.log(n/t)/Math.LN2,i=Math.pow(2,o*(a-1)),s=n*i;if(SYNTH.addVoice("pointer-"+e.pointerId,s,e.pressure,r),!points.has(e.pointerId)){var c=["#D34D2E","#FF9900","#F3CF3A","#44DE43","#3DC186","#37BBBA","#4DC3FA","#B158B6","#FB6368","#F23A65"];points.set(e.pointerId,{id:e.pointerId,x:e.pageX,y:e.pageY,color:c[Math.floor(Math.random()*c.length)]})}}).on("pointermove",function(e){if(e.originalEvent&&(e=e.originalEvent),SYNTH.voices.has("pointer-"+e.pointerId)){var t=27.5,n=SYNTH.context.sampleRate/2,a=1-1*e.pageY/paper.height,o=Math.log(n/t)/Math.LN2,i=Math.pow(2,o*(a-1)),r=n*i,t=27.5,n=4186.01,a=1*e.pageX/paper.width,o=Math.log(n/t)/Math.LN2,i=Math.pow(2,o*(a-1)),s=n*i;if(SYNTH.updateVoice("pointer-"+e.pointerId,s,null,r),points.has(e.pointerId)){var c=points.get(e.pointerId);c.x=e.pageX,c.y=e.pageY}}}).on("pointerup pointercancel pointerout pointerleave",function(e){e.originalEvent&&(e=e.originalEvent),SYNTH.removeVoice("pointer-"+e.pointerId),points.has(e.pointerId)&&points.delete(e.pointerId)}),$(document).on("touchmove",function(e){e.preventDefault()}),$(document).on("visibilitychange mozvisibilitychange msvisibilitychange webkitvisibilitychange",function(){(document.hidden||document.mozHidden||document.msHidden||document.webkitHidden)&&SYNTH.voices.forEach(function(e){SYNTH.removeVoice(e.id)})});