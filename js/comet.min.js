"use strict";function adaptScreen(){paper.height=Math.max(document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight),paper.width=Math.max(document.body.offsetWidth,document.documentElement.offsetWidth,document.body.clientWidth,document.documentElement.clientWidth),paper.size(paper.width,paper.height),ANIMATION.maxSpectrumHeight=paper.height/4*3}function draw(){var e=SYNTH.settings.animation.type;if("none"===e)return cancelAnimationFrame(ANIMATION.drawLoop),void paper.clear();ANIMATION.drawLoop=requestAnimationFrame(draw);var t=ANIMATION.dataArray;if("spectrum-linear"===e){SYNTH.nodes.analyser.getByteFrequencyData(ANIMATION.dataArray),paper.clear();for(var n=paper.width/(2*t.length),o=0;o<t.length;++o){var a=paper.height-ANIMATION.maxSpectrumHeight*t[o]/256;paper.rect({x:2*o*n,y:a,width:n,height:paper.height,fill:"hsl("+360*o/t.length+", 100%, 50%)"})}}else if("spectrum-round"===e){SYNTH.nodes.analyser.getByteFrequencyData(ANIMATION.dataArray);var r=360/t.length,i=window.innerWidth/2,s=window.innerHeight/2,c=80,l=3*c;paper.clear();for(var o=0;o<t.length;++o){var u=o*r*Math.PI/180,p=Math.cos(u),f=Math.sin(u),d=i+p*c,v=s+f*c,h=t[o]*l/512+c,m=i+p*h,g=s+f*h;paper.line({x1:d,y1:v,x2:m,y2:g,stroke:"hsl("+360*o/t.length+", 100%, 50%)",join:"miter",thickness:1})}}else if("spectrum-roundinset"===e){SYNTH.nodes.analyser.getByteFrequencyData(ANIMATION.dataArray);var r=360/t.length,i=window.innerWidth/2,s=window.innerHeight/2,c=240,l=c;paper.clear();for(var o=0;o<t.length;++o){var u=o*r*Math.PI/180,p=Math.cos(u),f=Math.sin(u),d=i+p*c,v=s+f*c,h=-(t[o]*l/512)+c,m=i+p*h,g=s+f*h;paper.line({x1:d,y1:v,x2:m,y2:g,stroke:"hsl("+360*o/t.length+", 100%, 50%)",join:"miter",thickness:1})}}else if("oscilloscope-stroked"===e){SYNTH.nodes.analyser.getByteTimeDomainData(ANIMATION.dataArray),paper.clear(),ANIMATION.hue=ANIMATION.hue+.5>360?0:ANIMATION.hue+.5,paper.context.strokeStyle="hsl("+ANIMATION.hue+", 50%, 50%)",paper.context.lineWidth=15,paper.context.beginPath();for(var N=1*paper.width/t.length,d=0,o=0;o<t.length;++o){var T=t[o]/128,v=T*paper.height/2;0===o?paper.context.moveTo(d,v):paper.context.lineTo(d,v),d+=N}paper.context.stroke()}else if("oscilloscope-filled"===e){SYNTH.nodes.analyser.getByteTimeDomainData(ANIMATION.dataArray),paper.clear(),paper.context.lineWidth=15,ANIMATION.hue=ANIMATION.hue+.5>360?0:ANIMATION.hue+.5,paper.context.fillStyle="hsl("+ANIMATION.hue+", 50%, 50%)",paper.context.beginPath();for(var N=1*paper.width/t.length,d=0,o=0;o<t.length;++o){var T=t[o]/128,v=T*paper.height/2;0===o?paper.context.moveTo(d,v):paper.context.lineTo(d,v),d+=N}paper.context.lineTo(paper.width,paper.height),paper.context.lineTo(0,paper.height),paper.context.fill()}else"blackboard"===e&&(paper.clear(),points.forEach(function(e){paper.circle({x:e.x,y:e.y,r:50,fill:e.color,shadow:"0 0 20 "+e.color})}))}$("#splash-screen").delay(2e3).fadeOut(),$("#module-info").delay(8e3).fadeOut(),$(".sidebar button").on("click",function(){var e=$("#module-"+$(this).data("module"));e.is(":visible")?e.hide():($(".module").hide(),e.show())});var SYNTH={nodes:{},voices:new Map,context:new(window.AudioContext||window.webkitAudioContext),presets:[],settings:{osc1:{type:"sawtooth",detune:0,mix:1},osc2:{type:"none",detune:0,mix:1},filter:{type:"lowpass",detune:0,frequency:0,quality:0,gain:0},effect:{type:"none",buffer:256},compressor:{threshold:-24,knee:30,ratio:12,reduction:0,attack:.003,release:.25},master:{volume:1,pan:0},animation:{type:"spectrum-round",fftSize:512,smoothingTimeConstant:.8,minDecibels:-100,maxDecibels:-30}},setupSettings:function(e){e&&(SYNTH.settings=$.extend(!0,SYNTH.settings,e)),e=SYNTH.settings,console.log("setupSettings",e);var t=SYNTH.nodes;$("#osc1-type").val(e.osc1.type).trigger("change"),$("#osc1-detune").val(e.osc1.detune).trigger("input"),$("#osc1-mix").val(e.osc1.mix).trigger("input"),$("#osc2-type").val(e.osc2.type).trigger("change"),$("#osc2-detune").val(e.osc2.detune).trigger("input"),$("#osc2-mix").val(e.osc2.mix).trigger("input"),t.sharedFilter.type=e.filter.type,t.sharedFilter.detune.value=e.filter.detune,t.sharedFilter.frequency.value=Math.min(e.filter.frequency,SYNTH.context.sampleRate/2),t.sharedFilter.Q.value=e.filter.quality,t.sharedFilter.gain.value=e.filter.gain,$("#filter-type").val(e.filter.type).trigger("change"),$("#filter-detune").val(e.filter.detune).trigger("input"),$("#filter-frequency").val(e.filter.frequency).trigger("input"),$("#filter-quality").val(e.filter.quality).trigger("input"),$("#filter-gain").val(e.filter.gain).trigger("input"),t.blender.gain.value=1,$("#effect-buffer").val(e.effect.buffer),$("#effect-type").val(e.effect.type).trigger("change"),t.compressor.threshold.value=e.compressor.threshold,t.compressor.knee.value=e.compressor.knee,t.compressor.ratio.value=e.compressor.ratio;try{t.compressor.reduction.value=e.compressor.reduction}catch(n){console.warn("compressor.reduction error",n)}t.compressor.attack.value=e.compressor.attack,t.compressor.release.value=e.compressor.release,$("#compressor-threshold").val(e.compressor.threshold).trigger("input"),$("#compressor-knee").val(e.compressor.knee).trigger("input"),$("#compressor-ratio").val(e.compressor.ratio).trigger("input"),$("#compressor-reduction").val(e.compressor.reduction).trigger("input"),$("#compressor-attack").val(e.compressor.attack).trigger("input"),$("#compressor-release").val(e.compressor.release).trigger("input"),t.panner.pan.value=e.master.pan,$("#master-pan").val(e.master.pan).trigger("input"),t.master.gain.value=e.master.volume,$("#master-volume").val(e.master.volume).trigger("input"),t.analyser.fftSize=e.animation.fftSize,t.analyser.smoothingTimeConstant=e.animation.smoothingTimeConstant,t.analyser.minDecibels=e.animation.minDecibels,t.analyser.maxDecibels=e.animation.maxDecibels,$("#animation-type").val(e.animation.type),$("#animation-analyser-fft").val(e.animation.fftSize).trigger("change"),$("#animation-analyser-smoothingTimeConstant").val(e.animation.smoothingTimeConstant).trigger("input"),$("#animation-analyser-minDecibels").val(e.animation.minDecibels).trigger("input"),$("#animation-analyser-maxDecibels").val(e.animation.maxDecibels).trigger("input")},addVoice:function(e,t,n,o){var a=SYNTH.settings,r=SYNTH.context.createOscillator();SYNTH.wavetables[a.osc1.type]?r.setPeriodicWave(SYNTH.wavetables[a.osc1.type].wave):r.type=a.osc1.type,r.frequency.value=t,r.detune.value=a.osc1.detune,r.start(0);var i=SYNTH.context.createGain();i.gain.value=a.osc1.mix;var s,c;"none"!==a.osc2.type&&(s=SYNTH.context.createOscillator(),SYNTH.wavetables[a.osc2.type]?s.setPeriodicWave(SYNTH.wavetables[a.osc2.type].wave):s.type=a.osc2.type,s.frequency.value=t,s.detune.value=a.osc2.detune,s.start(0),c=SYNTH.context.createGain(),c.gain.value=a.osc2.mix);var l=SYNTH.context.createGain();l.gain.value=n;var u=null;-1===e.indexOf("keyboard")&&(u=SYNTH.context.createBiquadFilter(),u.type=a.filter.type,u.detune.value=a.filter.detune,u.frequency.value=Math.min(o||a.filter.frequency,SYNTH.context.sampleRate/2),u.Q.value=a.filter.quality,u.gain.value=a.filter.gain),r.connect(i),i.connect(l),"none"!==a.osc2.type&&(s.connect(c),c.connect(l)),-1===e.indexOf("keyboard")?(l.connect(u),u.connect(SYNTH.nodes.blender)):l.connect(SYNTH.nodes.sharedFilter),SYNTH.voices.has(e)&&SYNTH.removeVoice(e),SYNTH.voices.set(e,{id:e,osc1:{osc:r,mix:i},osc2:"none"!==a.osc2.type?{osc:s,mix:c}:null,velocity:l,filter:u})},updateVoice:function(e,t,n,o){if(SYNTH.voices.has(e)){var a=SYNTH.voices.get(e);a.osc1.osc.frequency.value=t,null!==a.osc2&&(a.osc2.osc.frequency.value=t),null!==n&&(a.velocity.gain.value=n),null!==a.filter&&null!==o&&(a.filter.frequency.value=o)}},removeVoice:function(e){if(SYNTH.voices.has(e)){var t=SYNTH.voices.get(e);t.osc1.osc.stop(0),t.osc1.osc.disconnect(),t.osc1.mix.disconnect(),null!==t.osc2&&(t.osc2.osc.stop(0),t.osc2.osc.disconnect(),t.osc2.mix.disconnect()),t.velocity.disconnect(),null!==t.filter&&t.filter.disconnect(),SYNTH.voices.delete(e)}}};SYNTH.nodes.sharedFilter=SYNTH.context.createBiquadFilter(),SYNTH.nodes.blender=SYNTH.context.createGain(),SYNTH.nodes.compressor=SYNTH.context.createDynamicsCompressor(),SYNTH.nodes.panner=SYNTH.context.createStereoPanner(),SYNTH.nodes.master=SYNTH.context.createGain(),SYNTH.nodes.analyser=SYNTH.context.createAnalyser(),SYNTH.nodes.sharedFilter.connect(SYNTH.nodes.blender),SYNTH.nodes.blender.connect(SYNTH.nodes.compressor),SYNTH.nodes.compressor.connect(SYNTH.nodes.panner),SYNTH.nodes.panner.connect(SYNTH.nodes.master),SYNTH.nodes.master.connect(SYNTH.nodes.analyser),SYNTH.nodes.analyser.connect(SYNTH.context.destination),SYNTH.settings.filter.frequency=SYNTH.context.sampleRate/2,SYNTH.setupSettings(),SYNTH.wavetables={horn:{real:[0,.4,.4,1,1,1,.3,.7,.6,.5,.9,.8],imag:null}},function(){for(var e in SYNTH.wavetables)if(SYNTH.wavetables.hasOwnProperty(e)){var t=SYNTH.wavetables[e];t.real=new Float32Array(t.real),t.imag=new Float32Array(null!==t.imag?t.imag:t.real.length),t.wave=SYNTH.context.createPeriodicWave(t.real,t.imag)}}(),$("#osc1-type").on("change",function(){SYNTH.settings.osc1.type=$(this).val(),SYNTH.voices.forEach(function(e){SYNTH.removeVoice(e.id)})}),$("#osc1-detune").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc1.detune=e,SYNTH.voices.forEach(function(t){t.osc1.osc.detune.value=e})}),$("#osc1-mix").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc1.mix=e,SYNTH.voices.forEach(function(t){t.osc1.mix.gain.value=e})}),$("#osc2-type").on("change",function(){SYNTH.settings.osc2.type=$(this).val(),SYNTH.voices.forEach(function(e){SYNTH.removeVoice(e.id)})}),$("#osc2-detune").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc2.detune=e,SYNTH.voices.forEach(function(t){null!==t.osc2&&(t.osc2.osc.detune.value=e)})}),$("#osc2-mix").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.osc2.mix=e,SYNTH.voices.forEach(function(t){null!==t.osc2&&(t.osc2.mix.gain.value=e)})}),$("#filter-type").on("change",function(){SYNTH.settings.filter.type=$(this).val(),SYNTH.nodes.sharedFilter.type=$(this).val(),SYNTH.voices.forEach(function(e){null!==e.filter&&(e.filter.type=$(this).val())})}),$("#filter-detune").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.detune=e,SYNTH.nodes.sharedFilter.detune.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.detune.value=e)})}),$("#filter-frequency").attr("max",SYNTH.context.sampleRate/2).on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.frequency=e,SYNTH.nodes.sharedFilter.frequency.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.frequency.value=e)})}),$("#filter-quality").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.quality=e,SYNTH.nodes.sharedFilter.Q.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.Q.value=e)})}),$("#filter-gain").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.filter.gain=e,SYNTH.nodes.sharedFilter.gain.value=e,SYNTH.voices.forEach(function(t){null!==t.filter&&(t.filter.gain.value=e)})}),function(){SYNTH.buffers={};var e=[{name:"convolver-echo",url:"assets/echo.wav"},{name:"convolver-hall",url:"assets/hall.ogg"},{name:"convolver-muffler",url:"assets/muffler.wav"},{name:"convolver-spring_feedback",url:"assets/spring_feedback.wav"},{name:"convolver-telephone",url:"assets/telephone.wav"}],t=$("#effect-type");e.forEach(function(e){var n=new XMLHttpRequest;n.onload=function(){4!==n.readyState||n.status<200||n.status>299?console.error('"'+e.name+'" network response was not ok [ readyState: '+n.readyState+" - status: "+n.status+" "+n.statusText+" ]"):SYNTH.context.decodeAudioData(n.response).then(function(n){SYNTH.buffers[e.name]=n,t.find('option[value="'+e.name+'"]').prop("disabled",!1)}).catch(function(t){console.log('Error on "'+e.name+'" decodeAudioData [ERROR: '+t.toString()+"]")})},n.onerror=function(t){console.error('"'+e.name+'" network error',t)},n.open("GET",e.url,!0),n.responseType="arraybuffer",n.send()}),function(){for(var e=SYNTH.context.createBuffer(2,.5*SYNTH.context.sampleRate,SYNTH.context.sampleRate),n=e.getChannelData(0),o=e.getChannelData(1),a=0;a<e.length;++a)n[a]=2*Math.random()-1,o[a]=2*Math.random()-1;SYNTH.buffers["convolver-noise"]=e,t.find('option[value="convolver-noise"]').prop("disabled",!1)}()}(),$("#effect-buffer").on("change",function(){$("#effect-type").trigger("change")}),$("#effect-type").on("change",function(){if($(".effect-settings").hide(),SYNTH.nodes.effect&&(SYNTH.nodes.effect.disconnect(),delete SYNTH.nodes.effect),SYNTH.nodes.blender.disconnect(),"filter-pinking"===$(this).val()){var e=parseInt($("#effect-buffer").val(),10);SYNTH.nodes.effect=function(){var t,n,o,a,r,i,s;t=n=o=a=r=i=s=0;var c=SYNTH.context.createScriptProcessor(e,1,1);return c.onaudioprocess=function(e){for(var c=e.inputBuffer.getChannelData(0),l=e.outputBuffer.getChannelData(0),u=0;u<c.length;++u)t=.99886*t+.0555179*c[u],n=.99332*n+.0750759*c[u],o=.969*o+.153852*c[u],a=.8665*a+.3104856*c[u],r=.55*r+.5329522*c[u],i=-.7616*i-.016898*c[u],l[u]=t+n+o+a+r+i+s+.5362*c[u],l[u]*=.11,s=.115926*c[u]},c}()}else if("filter-moog"===$(this).val()){$("#moogfilter-settings").show();var e=parseInt($("#effect-buffer").val(),10);SYNTH.nodes.effect=function(){var t,n,o,a,r,i,s,c,l=SYNTH.context.createScriptProcessor(e,1,1);return t=n=o=a=r=i=s=c=0,l.cutoff=.065,l.resonance=3.99,l.onaudioprocess=function(e){for(var u=e.inputBuffer.getChannelData(0),p=e.outputBuffer.getChannelData(0),f=1.16*l.cutoff,d=l.resonance*(1-.15*f*f),v=0;v<u.length;++v)u[v]-=c*d,u[v]*=.35013*f*f*f*f,r=u[v]+.3*t+(1-f)*r,t=u[v],i=r+.3*n+(1-f)*i,n=r,s=i+.3*o+(1-f)*s,o=i,c=s+.3*a+(1-f)*c,a=s,p[v]=c},l}(),$("#moogfilter-cutoff, #moogfilter-resonance").trigger("input")}else if("filter-bitcrusher"===$(this).val()){$("#bitcrusher-settings").show();var e=parseInt($("#effect-buffer").val(),10);SYNTH.nodes.effect=function(){var t=SYNTH.context.createScriptProcessor(e,1,1);t.bits=4,t.normfreq=.1;var n=Math.pow(.5,t.bits),o=0,a=0;return t.onaudioprocess=function(e){for(var r=e.inputBuffer.getChannelData(0),i=e.outputBuffer.getChannelData(0),s=0;s<r.length;++s)o+=t.normfreq,o>=1&&(o-=1,a=n*Math.floor(r[s]/n+.5)),i[s]=a},t}(),$("#bitcrusher-bits, #bitcrusher-normfreq").trigger("input")}else if("filter-whitenoiser"===$(this).val()){var e=parseInt($("#effect-buffer").val(),10);SYNTH.nodes.effect=function(){var t=SYNTH.context.createScriptProcessor(e,1,1);return t.onaudioprocess=function(e){for(var t=e.inputBuffer.getChannelData(0),n=e.outputBuffer.getChannelData(0),o=0;o<t.length;++o)n[o]=t[o]+.2*(2*Math.random()-1)},t}()}else if("filter-pinknoiser"===$(this).val()){var e=parseInt($("#effect-buffer").val(),10);SYNTH.nodes.effect=function(){var t,n,o,a,r,i,s;t=n=o=a=r=i=s=0;var c=SYNTH.context.createScriptProcessor(e,1,1);return c.onaudioprocess=function(e){for(var c=e.inputBuffer.getChannelData(0),l=e.outputBuffer.getChannelData(0),u=0;u<c.length;++u){var p=c[u]+(2*Math.random()-1);t=.99886*t+.0555179*p,n=.99332*n+.0750759*p,o=.969*o+.153852*p,a=.8665*a+.3104856*p,r=.55*r+.5329522*p,i=-.7616*i-.016898*p,l[u]=t+n+o+a+r+i+s+.5362*p,l[u]*=.11,s=.115926*p}},c}()}else if("filter-brownnoiser"===$(this).val()){var e=parseInt($("#effect-buffer").val(),10);SYNTH.nodes.effect=function(){var t=SYNTH.context.createScriptProcessor(e,1,1),n=0;return t.onaudioprocess=function(e){for(var t=e.inputBuffer.getChannelData(0),o=e.outputBuffer.getChannelData(0),a=0;a<t.length;++a){var r=t[a]+(2*Math.random()-1);o[a]=(n+.02*r)/1.02,n=o[a],o[a]*=3.5}},t}()}else if(-1!==$(this).val().indexOf("convolver")){var t=$(this).val();SYNTH.buffers[t]&&(SYNTH.nodes.effect=function(){var e=SYNTH.context.createConvolver();return e.buffer=SYNTH.buffers[t],e}())}else"waveshaper-distorsion"===$(this).val()?SYNTH.nodes.effect=function(){var e=SYNTH.context.createWaveShaper(),t=function(e){for(var t="number"==typeof e?e:50,n=44100,o=new Float32Array(n),a=Math.PI/180,r=0;n>r;++r){var i=2*r/n-1;o[r]=(3+t)*i*20*a/(Math.PI+t*Math.abs(i))}return o};return e.curve=t(100),e.oversample="4x",e}():"delay-feedback"===$(this).val()&&(SYNTH.nodes.effect=function(){var e=SYNTH.context.createDelay(5);e.delayTime.value=.1;var t=SYNTH.context.createGain();return t.gain.value=.3,e.connect(t),t.connect(e),e}());SYNTH.nodes.effect?(SYNTH.nodes.blender.connect(SYNTH.nodes.effect),SYNTH.nodes.effect.connect(SYNTH.nodes.compressor)):SYNTH.nodes.blender.connect(SYNTH.nodes.compressor)}),$("#moogfilter-cutoff").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.effect.cutoff=e}),$("#moogfilter-resonance").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.effect.resonance=e}),$("#bitcrusher-bits").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.effect.bits=e}),$("#bitcrusher-normfreq").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.effect.normfreq=e}),$("#compressor-threshold").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.threshold=e,SYNTH.nodes.compressor.threshold.value=e}),$("#compressor-knee").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.knee=e,SYNTH.nodes.compressor.knee.value=e}),$("#compressor-ratio").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.ratio=e,SYNTH.nodes.compressor.ratio.value=e}),$("#compressor-reduction").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.reduction=e;try{SYNTH.nodes.compressor.reduction.value=e}catch(t){console.warn("compressor.reduction error",t)}}),$("#compressor-attack").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.attack=e,SYNTH.nodes.compressor.attack.value=e}),$("#compressor-release").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.compressor.release=e,SYNTH.nodes.compressor.release.value=e}),$("#master-volume").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.master.volume=e,SYNTH.nodes.master.gain.value=e}),$("#master-pan").on("input",function(){var e=parseFloat($(this).val());SYNTH.settings.master.pan=e,SYNTH.nodes.panner.pan.value=e}),window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame;var paper=new Palette("surface");window.ANIMATION={dataArray:new Uint8Array(SYNTH.nodes.analyser.frequencyBinCount),drawLoop:null,hue:0,maxSpectrumHeight:paper.height/4*3},$(window).on("resize",adaptScreen).trigger("resize"),$("#animation-type").on("change",function(){SYNTH.settings.animation.type=$(this).val(),cancelAnimationFrame(ANIMATION.drawLoop),draw()}).trigger("change"),$("#animation-analyser-fft").on("change",function(){SYNTH.nodes.analyser.fftSize=parseInt($(this).val(),10),ANIMATION.dataArray=new Uint8Array(SYNTH.nodes.analyser.frequencyBinCount),$("#animation-type").trigger("change")}),$("#animation-analyser-smoothingTimeConstant").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.analyser.smoothingTimeConstant=e}),$("#animation-analyser-minDecibels").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.analyser.minDecibels=e}),$("#animation-analyser-maxDecibels").on("input",function(){var e=parseFloat($(this).val());SYNTH.nodes.analyser.maxDecibels=e}),[{name:"Default"},{name:"Absolute Leader",osc1:{type:"horn",detune:-5,mix:.68},osc2:{type:"sawtooth",detune:-1200,mix:.55},animation:{type:"oscilloscope-stroked"}},{name:"Buzzer",osc1:{type:"sawtooth",detune:0,mix:1},osc2:{type:"sawtooth",detune:-1200,mix:.5},filter:{type:"lowpass",detune:0,frequency:3e3,quality:26,gain:0}},{name:"ChipChip",osc1:{type:"square",detune:464,mix:1},filter:{type:"highpass",detune:0,frequency:5e3,quality:30,gain:0}},{name:"Classic Electric Bass",osc1:{type:"sine",detune:0,mix:1},osc2:{type:"sine",detune:1200,mix:1}},{name:"Organth",osc1:{type:"sawtooth",detune:-456,mix:1},filter:{type:"highpass",detune:0,frequency:1716,quality:9.6,gain:18}}].forEach(function(e,t){var n=$.extend(!0,{id:t},SYNTH.settings);SYNTH.presets.push($.extend(!0,n,e))}),$("#preset-id").on("change",function(){for(var e=parseInt($(this).val(),10),t=0;t<SYNTH.presets.length;++t)if(e===SYNTH.presets[t].id){SYNTH.setupSettings(SYNTH.presets[t]);break}}).on("update",function(e){var t=$(this),n=null!==t.val()?t.val():0;t.empty(),SYNTH.presets.forEach(function(e){t.append('<option value="'+e.id+'">'+e.name+"</option>")}),t.val(void 0!==e.toBeSelected?e.toBeSelected:n).trigger("change")}).trigger("update"),$("#preset-save").on("click",function(){var e=prompt("Preset name");if(e){var t=$.extend(!0,{},SYNTH.settings),n=$.extend(!0,t,{id:Date.now(),name:e});SYNTH.presets.push(n),$("#preset-id").trigger({type:"update",toBeSelected:n.id})}}),function(){function e(e){var t=document.getElementById("keyboard");t&&t.remove(),t=document.createElement("div"),t.hidden=!0,t.setAttribute("id","keyboard"),document.body.appendChild(t);var n=new QwertyHancock({id:"keyboard",width:window.innerWidth,height:window.innerHeight/2,octaves:2,startNote:e,whiteKeyColour:"#E7ECEE",blackKeyColour:"#1F2022",activeColour:"#46C891",borderColour:"black",keyboardLayout:"en"});return n.keyDown=function(e,t){SYNTH.addVoice("keyboard-"+e,t,.5)},n.keyUp=function(e){SYNTH.removeVoice("keyboard-"+e)},n}e("C4")}();var points=new Map,smartOSCFrequency=function(e,t){var n=27.5,o=2e3,a=1*e/t,r=Math.log(o/n)/Math.LN2,i=Math.pow(2,r*(a-1)),s=o*i;return s},smartFilterFrequency=function(e,t){var n=27.5,o=SYNTH.context.sampleRate/2,a=1-1*e/t,r=Math.log(o/n)/Math.LN2,i=Math.pow(2,r*(a-1)),s=o*i;return s};$("#surface").on("pointerenter pointerover",function(e){e.originalEvent&&(e=e.originalEvent)}).on("pointerdown",function(e){if(e.originalEvent&&(e=e.originalEvent),SYNTH.addVoice("pointer-"+e.pointerId,smartOSCFrequency(e.pageX,paper.width),e.pressure,smartFilterFrequency(e.pageY,paper.height)),!points.has(e.pointerId)){var t=["#D34D2E","#FF9900","#F3CF3A","#44DE43","#3DC186","#37BBBA","#4DC3FA","#B158B6","#FB6368","#F23A65"];points.set(e.pointerId,{id:e.pointerId,x:e.pageX,y:e.pageY,color:t[Math.floor(Math.random()*t.length)]})}}).on("pointermove",function(e){if(e.originalEvent&&(e=e.originalEvent),SYNTH.voices.has("pointer-"+e.pointerId)&&(SYNTH.updateVoice("pointer-"+e.pointerId,smartOSCFrequency(e.pageX,paper.width),null,smartFilterFrequency(e.pageY,paper.height)),points.has(e.pointerId))){var t=points.get(e.pointerId);t.x=e.pageX,t.y=e.pageY}}).on("pointerup pointercancel pointerout pointerleave",function(e){e.originalEvent&&(e=e.originalEvent),SYNTH.removeVoice("pointer-"+e.pointerId),points.has(e.pointerId)&&points.delete(e.pointerId)}),navigator.requestMIDIAccess?$("#button-midi").on("click",function(){navigator.requestMIDIAccess().then(function(e){console.log("MIDI ready!",e);var t=0;e.inputs.forEach(function(e){e.onmidimessage=function(e){var t=240&e.data[0],n=e.data[1],o=e.data[2],a=440*Math.pow(2,(n-69)/12);144===t&&0!==o?SYNTH.addVoice("midi-"+n,a,o/127):(128===t||0===o)&&SYNTH.removeVoice("midi-"+n)}}),alert(t>0?"MIDI connection ready!":"No MIDI input detected!")},function(e){console.log("Failed to get MIDI access",e),alert("Failed to get MIDI access\n\n"+e)})}):$("#button-midi").remove(),$(document).on("touchmove",function(e){e.preventDefault()}),$(document).on("visibilitychange mozvisibilitychange msvisibilitychange webkitvisibilitychange",function(){(document.hidden||document.mozHidden||document.msHidden||document.webkitHidden)&&SYNTH.voices.forEach(function(e){SYNTH.removeVoice(e.id)})});